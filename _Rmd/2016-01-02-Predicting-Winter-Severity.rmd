---
layout: post
title:  "Hotter summer, warmer winters? Predicting winter severity from summer temperatures"
date:   2016-10-01 9:22:52 -0500
categories: modelling prediction climateChange
status: process
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(zoo)
library(plyr)
library(ggplot2)
library(randomForest)
library(reshape2)
shift <- function(x, n){
  c(x[-(seq(n))], rep(NA, n))
}
library(timeDate)
```

Last week, when I was at the [Climate Informatics](https://www2.cisl.ucar.edu/events/workshops/ci2016) workshop in Boulder, CO, there were a lot of good papers using modeling to predict weather and climate patterns.  One question that I've been interested in looking at for awhile, but never got around to analyzing, is how climate change is expected to affect winters here in Madison, and particularly, if we have an especially warm summer, can we expect a warmer winter?  After getting back from Boulder, I started digging into the data, and it does look like there is some relationship between summer temperatures and winter temperatures.  So, can we predict winter severity in, say, October?  

Be warned, I haven't done my homework on this one, there may well be papers that do the same thing in a better way, but this is a good exercise on time series analysis and it gives interesting results.

### The Problem
Predict winter severity in Madison, WI using daily weather observations, using only observations through October, so our prediction will have a 3-4 month lead time. Winter severity can mean a couple of different things, but for now, let's say winter severity is measured by the mean temperature in February. 

###  The Data
I have a 170 year time series of daily weather observations from the [National Climate Data Center](https://www.ncdc.noaa.gov/cdo-web/) which contains 62,407 daily records of weather observables including maximum and minimum temperature, snow depth and accummulation, and precipitation.  

```{r timeseriesplot}
climateData <- read.csv("/users/scottsfarley/documents/madison_weather.csv")

## approximate -9999
climateData[climateData == -9999] = NA
climateData <- data.frame(na.approx(climateData))
climateTS <- ts(climateData, start = 1869, freq=365)
climateData$TMEAN <- (climateData$TMAX + climateData$TMIN) / 2
climateData$Month <- as.factor(climateData$Month)
```

```{r pressure, echo=FALSE}
baseClimate <- climateData[climateData$Year >= 1950,]
baseClimate <- baseClimate[baseClimate$Year < 1990,]

climateAvgs <- ddply(baseClimate, .(Day, Month), summarise,
                     TMAX = mean(TMAX),
                     TMIN = mean(TMIN),
                     PRCP = mean(PRCP),
                     SNOW = sum(SNOW),
                     SNOWD = sum(SNOWD),
                     TMEAN = mean(TMEAN)
                    )

tmaxAnom <- vector()
tminAnom <- vector()
prcpAnom <- vector()
snowAnom <- vector()
snowdAnom <- vector()
tmeanAnom <- vector()

for (i in 1:nrow(climateData)){
  x <- climateData[i,]
  day <- x[['Day']]
  month <- x[['Month']]
  avg <- climateAvgs[(climateAvgs$Month == month & climateAvgs$Day == day),]
  prcp <- x[['PRCP']] - avg$PRCP
  snowd <- x[['SNOWD']] - avg$SNOWD
  snow <- x[['SNOW']] - avg$SNOW
  tmax <- x[['TMAX']] - avg$TMAX
  tmin <- x[['TMIN']] - avg$TMIN
  tmean <- x[['TMEAN']] - avg$TMEAN
  if (is.na(prcp)){
    prcp <- NA
  }
  if (is.na(snowd)){
    snowd <- NA
  }
  if(is.na(snow)){
    snow <- NA
  }
  if (is.na(tmax)){
    tmax <- NA
  }
  if (is.na(tmin)){
    tmin <- NA
  }
  tminAnom[i] <- tmin
  tmaxAnom[i] <- tmax
  prcpAnom[i] <- prcp
  snowAnom[i] <- snow
  snowdAnom[i] <- snowd
  tmeanAnom [i] <- tmean
}


climateAnom <- data.frame(
  PRCP = prcpAnom, 
  TMAX = tmaxAnom,
  TMIN = tminAnom,
  SNOW = snowAnom,
  SNOWD = snowdAnom,
  TMEAN = tmeanAnom
  )
climateAnom$Day <- climateData$Day
climateAnom$Month <- climateData$Month
climateAnom$Year <- climateData$Year
```

```{r monthlyAnoms}
tmaxAnom.monthly <- vector()
tminAnom.monthly <- vector()
prcpAnom.monthly <- vector()
snowAnom.monthly <- vector()
snowdAnom.monthly <- vector()
tmeanAnom.monthly <- vector()

climateAvgs.monthly <- ddply(baseClimate, .(Month), summarise,
                     TMAX = mean(TMAX),
                     TMIN = mean(TMIN),
                     PRCP = mean(PRCP),
                     SNOW = sum(SNOW),
                     SNOWD = sum(SNOWD),
                     TMEAN = mean(TMEAN)
                    )

climateData.monthly <- ddply(climateData, .(Month, Year), summarise,
                     TMAX = mean(TMAX),
                     TMIN = mean(TMIN),
                     PRCP = mean(PRCP),
                     SNOW = sum(SNOW),
                     SNOWD = sum(SNOWD),
                     TMEAN = mean(TMEAN)
                    )
for (i in 1:nrow(climateData.monthly)){
  x <- climateData.monthly[i,]
  day <- x[['Day']]
  month <- x[['Month']]
  avg <- climateAvgs.monthly[climateAvgs.monthly$Month == month,]
  prcp <- x[['PRCP']] - avg$PRCP
  snowd <- x[['SNOWD']] - avg$SNOWD
  snow <- x[['SNOW']] - avg$SNOW
  tmax <- x[['TMAX']] - avg$TMAX
  tmin <- x[['TMIN']] - avg$TMIN
  tmean <- x[['TMEAN']] - avg$TMEAN
  if (is.na(prcp)){
    prcp <- NA
  }
  if (is.na(snowd)){
    snowd <- NA
  }
  if(is.na(snow)){
    snow <- NA
  }
  if (is.na(tmax)){
    tmax <- NA
  }
  if (is.na(tmin)){
    tmin <- NA
  }
  tminAnom.monthly[i] <- tmin
  tmaxAnom.monthly[i] <- tmax
  prcpAnom.monthly[i] <- prcp
  snowAnom.monthly[i] <- snow
  snowdAnom.monthly[i] <- snowd
  tmeanAnom.monthly[i] <- tmean
}


climateAnom.monthly <- data.frame(PRCP = prcpAnom.monthly, 
  TMAX = tmaxAnom.monthly,
  TMIN = tminAnom.monthly,
  SNOW = snowAnom.monthly,
  SNOWD = snowdAnom.monthly,
  TMEAN = tmeanAnom.monthly
  )
climateAnom.monthly$Month <- climateData.monthly$Month
climateAnom.monthly$Year <- climateData.monthly$Year
```

```{r plotFeb}
febTS <- climateData[climateData$Month == 2,]
ggplot(febTS) + geom_histogram(aes(TMEAN), binwidth = 0.5) + ggtitle("Daily February Mean Temperatures") 
```
A histogram of daily temperatures in February shows that there is pretty-normal looking variation centered around a mean of 21.1 with a standard deviation of about 11. A time series of the observed record suggests that there is pretty significant year to year variation in the mean as well. Notice that you can pick out the *Polar Vortez* of 2014 and the relative mild winter we had last year in 2015.

The first thing that I want to look at is the influence of summer temperatures on winter temps. It seems logical that if we have a super warm summer, the following winter might be more mild.  







```{r predPlotSetup}

climateAnom.monthly <- climateAnom.monthly[climateAnom.monthly$Year >= 1870,]

janAnoms <- climateAnom.monthly[climateAnom.monthly$Month == 1,]
janMin <-  shift(janAnoms$TMIN, 1)
janMax <- shift(janAnoms$TMAX, 1)
janMean <- (shift(janAnoms$TMAX, 1) + shift(janAnoms$TMIN, 1))/2
febAnoms <- climateAnom.monthly[climateAnom.monthly$Month == 2,]
febMin <-  shift(febAnoms$TMIN, 1)
febMax <- shift(febAnoms$TMAX, 1)
febMean <- (shift(febAnoms$TMAX, 1) + shift(janAnoms$TMIN, 1))/2
marchAnoms <- climateAnom.monthly[climateAnom.monthly$Month == 3,]
marchMin <-  shift(marchAnoms$TMIN, 1)
marchMax <- shift(marchAnoms$TMAX, 1)
marchMean <- (shift(marchAnoms$TMAX, 1) + shift(marchAnoms$TMIN, 1))/2

juneAnoms <- climateAnom.monthly[climateAnom.monthly$Month == 6,]
juneMin <-  juneAnoms$TMIN
juneMax <- juneAnoms$TMAX
juneMean <- (juneAnoms$TMAX + juneAnoms$TMIN)/2
julyAnoms <- climateAnom.monthly[climateAnom.monthly$Month == 7,]
julyMin <-  julyAnoms$TMIN
julyMax <- julyAnoms$TMAX
julyMean <- (julyAnoms$TMAX + julyAnoms$TMIN)/2
augAnoms <- climateAnom.monthly[climateAnom.monthly$Month == 8,]
augMin <-  augAnoms$TMIN
augMax <- augAnoms$TMAX
augMean <- (augAnoms$TMAX + augAnoms$TMIN)/2
septAnoms <- climateAnom.monthly[climateAnom.monthly$Month == 9,]
septMin <-  septAnoms$TMIN
septMax <- septAnoms$TMAX
septMean <- (septAnoms$TMAX + septAnoms$TMIN)/2
summerMin <- (juneMin + julyMin + augMin + septMin)/4
summerMax <- (juneMax + julyMax + augMax + septMax)/4
summerMean <- (juneMean + julyMean + augMean + septMean)/4
winterMin <- (janMin + febMin + marchMin)/3
winterMax <- (janMax + febMax + marchMax)/3
winterMean <- (janMean+ febMean + marchMean)/3




anomMat <- data.frame(
  janMin = janMin,
  janMax = janMax,
  janMean = janMean,
  febMin = febMin,
  febMax = febMax,
  febMean = febMean,
  marchMin = marchMin,
  marchMax = marchMax,
  marchMean = marchMean,
  juneMin = juneMin,
  juneMax = juneMax,
  juneMean = juneMean,
  julyMin = julyMin,
  julyMax = julyMax,
  julyMean = julyMean,
  augMin = augMin,
  augMax = augMax,
  augMean = augMean,
  septMin = septMin,
  septMax = septMax,
  septMean = septMean,
  winterMin = winterMin,
  winterMax = winterMax,
  winterMean = winterMean,
  summerMin = summerMin,
  summerMax = summerMax,
  summerMean = summerMean,
  year = unique(climateAnom.monthly$Year)
  )
```

```{r}
m1 <- lm(febMean ~ julyMean, data=anomMat)
m2 <- lm(febMean ~ augMean, data=anomMat)
m3 <- lm(febMean ~ septMean, data=anomMat)
ggplot(anomMat) + 
  geom_point(aes(x = julyMean, y = febMean, col='July')) +  
  geom_point(aes(x = augMean, y = febMean, col='August')) +  
geom_point(aes(x = septMean, y = febMean, col='September')) +  
geom_abline(intercept = m1$coefficients[[1]], slope=m1$coefficients[[2]], col='red')+
geom_abline(intercept = m2$coefficients[[1]], slope=m2$coefficients[[2]], col='green') +
geom_abline(intercept = m3$coefficients[[1]], slope=m3$coefficients[[2]], col='blue') +
  xlab("Summer Month Mean Temperature Anomaly") +
  ylab("February Mean Temperature Anomaly") +
  ggtitle("Summer Month Tmean Anomaly vs. February Tmean Anomaly")

predMat <- na.omit(anomMat)
p1 <- predict(m1, predMat)
p2 <- predict(m2, predMat)
p3 <- predict(m3, predMat)

r2.1 <- (cor(p1, predMat$febMean))^2 * 100
r2.2 <- (cor(p2, predMat$febMean))^2 * 100
r2.3 <- (cor(p3, predMat$febMean))^2 * 100

```

If we plot temperature anomalies of each of the summer months (JAS) against the mean temperature of the following February, there's very little relationship. A simple linear regression suggests that there might be a small linear relationship (slopes between 0.07 and 0.11). The models suggest that mean temperatures in the summer only explain between 0.3% and 1.5% of the temperature variance in february.

```{r}
m1 <- lm(febMean ~ julyMax, data=anomMat)
m2 <- lm(febMean ~ augMax, data=anomMat)
m3 <- lm(febMean ~ septMax, data=anomMat)
ggplot(anomMat) + 
  geom_point(aes(x = julyMax, y = febMean, col='July')) +  
  geom_point(aes(x = augMax, y = febMean, col='August')) +  
geom_point(aes(x = septMax, y = febMean, col='September')) +  
geom_abline(intercept = m1$coefficients[[1]], slope=m1$coefficients[[2]], col='red')+
geom_abline(intercept = m2$coefficients[[1]], slope=m2$coefficients[[2]], col='green') +
geom_abline(intercept = m3$coefficients[[1]], slope=m3$coefficients[[2]], col='blue') +
  xlab("Summer Month Mean Temperature Anomaly") +
  ylab("February Mean Temperature Anomaly") +
  ggtitle("Summer Month Tmax Anomaly vs. February Tmean Anomaly")

predMat <- na.omit(anomMat)
p1 <- predict(m1, predMat)
p2 <- predict(m2, predMat)
p3 <- predict(m3, predMat)

r2.1 <- (cor(p1, predMat$febMean))^2 * 100
r2.2 <- (cor(p2, predMat$febMean))^2 * 100
r2.3 <- (cor(p3, predMat$febMean))^2 * 100
```

But what if it's not just the mean temperature in the summer that's important, but rather the hottest that it gets -- maximum temperature. There appears to be a slightly stronger relationship between maximum temp in the summer and mean temp in february, though it's still pretty weak.  The linear slope coefficients are ~0.1 for July and August and about 0.2 for September. The $r^2$ values for these models still show that maximum temperature only accounts for between 0.3% and 1.5% of winter variability.

```{r}
m1 <- lm(febMean ~ julyMin, data=anomMat)
m2 <- lm(febMean ~ augMin, data=anomMat)
m3 <- lm(febMean ~ septMin, data=anomMat)
ggplot(anomMat) + 
  geom_point(aes(x = julyMin, y = febMean, col='July')) +  
  geom_point(aes(x = augMin, y = febMean, col='August')) +  
geom_point(aes(x = septMin, y = febMean, col='September')) +  
geom_abline(intercept = m1$coefficients[[1]], slope=m1$coefficients[[2]], col='red')+
geom_abline(intercept = m2$coefficients[[1]], slope=m2$coefficients[[2]], col='green') +
geom_abline(intercept = m3$coefficients[[1]], slope=m3$coefficients[[2]], col='blue') +
  xlab("Summer Month Mean Temperature Anomaly") +
  ylab("February Mean Temperature Anomaly") +
  ggtitle("Summer Month Tmin Anomaly vs. February Tmean Anomaly")

predMat <- na.omit(anomMat)
p1 <- predict(m1, predMat)
p2 <- predict(m2, predMat)
p3 <- predict(m3, predMat)

r2.1 <- (cor(p1, predMat$febMean))^2 * 100
r2.2 <- (cor(p2, predMat$febMean))^2 * 100
r2.3 <- (cor(p3, predMat$febMean))^2 * 100
```

And, unfortunately, there's even less evidence for a relationship between summer minimum temperatures and February means. 

Perhaps ENSO has a teleconnection linking tropical SST with midwestern winter temperatures?

```{r}
nino <- read.csv("/Users/scottsfarley/documents/nino34.csv")
nino.vector <- vector()
nino.months <- vector()
nino.years <- vector()
idx <- 1
for (i in 1:nrow(nino)){
  row <- nino[i, ]
  for (j in 2:length(row)){
    value = row[[j]]
    month = j
    year = row[[1]]
    nino.vector[idx] <- value
    nino.months[idx] <- month
    nino.years[idx] <- year
    idx = idx + 1
  }
}

nino <- data.frame(Month=nino.months, Year = nino.years, Nino = nino.vector)


nino <- nino[nino$Year <= 2015, ]
climateAnom.monthly <- climateAnom.monthly[climateAnom.monthly$Year <= 2015,]

ninoAvg <- ddply(nino, .(Year), summarise, nino = mean(Nino))
nino$avg <- ninoAvg$nino

climateAnom.monthly$NINO <- nino$Nino

febAnoms <- climateAnom.monthly[climateAnom.monthly$Month == 2, ]

m1 <- lm(TMEAN ~ NINO, data=febAnoms)
ggplot(febAnoms) + geom_point(aes(x = NINO, y = TMEAN)) + 
  geom_abline(slope=m1$coefficients[[2]], intercept=m1$coefficients[[1]]) +
  xlab("Nino 34 Index") +
  ylab("February Mean Temperature Anomaly") +
  ggtitle("El Nino Phase (Feb) vs. February Tmean Anomaly")

p1 <- predict(m1, febAnoms)
r2.1 <- (cor(p1, febAnoms$TMEAN))^2 * 100
```

Positive ENSO phases appear to have a negative relationship with winter temperatures, but, again, a pretty weak one.  The slope of the regression is -1.0148, and the $r^2$ variance explained is 1.82%. 

So it's not looking super promising to try to predict winter temperatures from the preceeding summer or from long-distance teleconnections.  So far, we've been looking at monthly averages, though.  Maybe there's some information in the day-to-day variation through the summer that's important to predicting the winter. Let's try predicting the following february mean from the first 270 days the year before (January through September).  The will give us, hopefully, some autocorrelation with the last February, but will still be a metric that we can predict with several months of lead time. We'll use maximum and temperature for each day, but not the mean (since it's a combination of the two, the information there should already be contained in the other two).

```{r}

climateAnom$dateString <- paste(climateAnom$Year, climateAnom$Month, climateAnom$Day, sep="-")
climateAnom$DOY <- dayOfYear(timeDate(climateAnom$dateString, format = "%Y-%m-%d"))

climateAnom.predictors <- climateAnom[climateAnom$DOY < 271,]
climateAnom.predictors <- climateAnom.predictors[c("Month", "Year", "Day", "TMAX", "TMIN", "DOY")]

climateAnom.predictors <- ddply(climateAnom.predictors, .(Month, Day, Year, DOY), summarise,
                                TMAX = mean(TMAX),
                                TMIN = mean(TMIN))

```

```{r}
x <- list()
years <- unique(climateAnom.predictors$Year)
y <- vector()
for (i in 1:(length(years)-1)){
  thisYear <- years[[i]]
  thesePredictors <- climateAnom.predictors[climateAnom.predictors$Year == thisYear, ]
  tmax <- thesePredictors$TMAX
  tmin <- thesePredictors$TMIN
  v <- c(tmax, tmin)
  x[[i]] <- v
  print(length(v))
  response <- climateAnom.predictors[climateAnom.predictors$Year == (thisYear + 1 ), ]
  response <- response[response$Month == 2, ]
  response$TMEAN <- (response$TMAX + response$TMIN)/2
  response <- mean(response$TMEAN)
  print(response)
  y[[i]] <- response
}

x[[37]] <-NULL
y[[37]] <- NA
y <- na.omit(y)
X <- vector()
for (i in 1:length(x)){
  X <- c(X, x[[i]])
}
X <- data.frame(matrix(X, nrow = 146))


model <- randomForest(X, y)


modelResults <- data.frame(predicted = model$predicted, obs = y)

m1 <- lm(predicted ~ obs, data=modelResults)

ggplot(modelResults) + geom_point(aes(x = obs, y = predicted)) + 
  geom_abline(intercept = m1$coefficients[[1]], slope = m1$coefficients[[2]])

r2 <-( cor(modelResults$predicted, modelResults$obs))^2

predNames <- c(paste("TMAX", 1:270), paste("TMIN", 1:270))
imp <- model$importance
imp <- data.frame(imp)
rownames(imp) <- as.factor(predNames)
imp$name <- predNames
ggplot(imp)  + geom_bar(aes(x = name, y=IncNodePurity), stat='identity') +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
   scale_x_discrete(breaks = levels(imp$name), labels=levels(imp$name))

```

Even if we through a huge amount of data at the problem, we still don't get a reasonable prediction.  If we look at the variable importance, we do see that a the temperatures on a couple of days give a lot of information, but I'm not sure of the reliability of these estimates.  In any case, I doubt the temperatures on one day in May really are the key to temperatures in February. 


#### Using Paleodata
Well, okay.  Perhaps we can't predict annual variations of winter temperatures using the day at hand, but maybe we can predict longer-scale temperature variations using the same methodology. The variations in the longer time series show much lower variance from the mean (~2 degrees) rather than the ~10+ degrees seen in annual variation.

I got the time series for Madison going back to the last glacial maximum using the CCSM 3 climate model. I used the downscaled and debiased data for North America from [Lorenz et al](http://www.nature.com/articles/sdata201648). The data contains decadally averaged model simulations for monthly maximum temperature, minimum temperature, and precipitation.  The data spans the last 22kya since the LGM, which gives me an additional 26,448 data points to work with. With pre-averaged/smooth data, the question becomes, can we predict variations on a longer time scale (~decades to centuries). This is less interesting to me if I want to predict how cold I'll be during the Berkie this year, but it's interesting in the case of climate change and global warming.

```{r}
paleo <- read.csv("/users/scottsfarley/documents/long_climate_MSN.csv")
``` 

In this case, there's been a lot of millenial scale changes since deglaciations.  I'll use anomalies from a 100-year (10-period) rolling mean, so that local anomalies are picked up but not the very long time scale trends. 

```{r}
library(zoo)
p.tmin.mean <- rollmean(paleo$TMIN, 10)
p.tmax.mean <- rollmean(paleo$TMAX, 10)
plot(p.tmin.mean, type='l')
```


